<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Babe Sculpting</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Babe Sculpting">

<style>
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,sans-serif;
    background:#f4f4f4;
    padding:20px;
    color:#222;
    display:flex;
    flex-wrap:wrap;
    gap:20px;
    justify-content:space-around;

    padding-top: calc(20px + env(safe-area-inset-top));
    padding-right: calc(20px + env(safe-area-inset-right));
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    padding-left: calc(20px + env(safe-area-inset-left));
  }

  .thumbnail-container{
    position:relative;
    flex:1 1 calc(33% - 20px);
    max-width:300px;
    aspect-ratio:1;
    border-radius:10px;
    overflow:hidden;
    cursor:pointer;
    box-shadow:0 4px 6px rgba(0,0,0,.1);
    transition:transform .2s, box-shadow .2s;
    background:#fff;
    -webkit-tap-highlight-color: transparent;
  }
  .thumbnail-container:hover{ transform:scale(1.06); box-shadow:0 6px 10px rgba(0,0,0,.2); }
  .thumbnail-container:active{ transform:scale(1.02); }
  .thumbnail-container img{ width:100%; height:100%; object-fit:cover; display:block; }
  .label{
    position:absolute; left:0; right:0; bottom:0;
    background:rgba(0,0,0,.6);
    color:#fff;
    text-align:center;
    padding:10px 8px;
    font-size:18px;
    font-weight:800;
    letter-spacing:.5px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .controls{
    width:100%;
    display:flex;
    justify-content:center;
    gap:16px;
    margin-top:10px;
    flex-wrap:wrap;
  }
  .controls button{
    padding:10px 18px;
    font-size:16px;
    font-weight:800;
    border-radius:12px;
    border:1px solid #ddd;
    background:#fff;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    -webkit-tap-highlight-color: transparent;
    transition:transform .08s ease, background .15s ease;
  }
  .controls button:active{ transform:scale(.98); background:#f6f6f6; }

  .overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.55);
    z-index:999;
    display:none;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  /* ✅ FIX: make panel a flex column and avoid 100vh math */
  #panel{
    position:fixed;
    inset: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    z-index:1000;
    padding:0;
    border-radius:16px;
    background: rgba(245,245,247,.92);
    box-shadow:0 20px 50px rgba(0,0,0,.35);

    display:flex;              /* ✅ */
    flex-direction:column;     /* ✅ */
    min-height:0;              /* ✅ allows inner scrolling */

    transform: translateY(18px);
    opacity:0;
    pointer-events:none;
    transition: transform .18s ease, opacity .18s ease;
  }
  #panel.show{ transform: translateY(0); opacity:1; pointer-events:auto; }

  .panel-header{
    position:sticky; top:0;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px 12px;
    background: rgba(255,255,255,.90);
    border-bottom:1px solid #e6e6e6;
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    flex:0 0 auto;             /* ✅ */
  }
  .panel-title{
    font-weight:900; font-size:16px; letter-spacing:.2px; color:#111;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .panel-close{
    border:1px solid #ddd;
    background:#fff;
    border-radius:12px;
    padding:10px 12px;
    font-weight:900;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    -webkit-tap-highlight-color: transparent;
  }
  .panel-close:active{ transform: scale(.98); }

  /* ✅ FIX: flex body fills remaining space and scrolls to the REAL bottom */
  .panel-body{
    flex:1 1 auto;              /* ✅ */
    min-height:0;               /* ✅ */
    overflow:auto;              /* ✅ */
    -webkit-overflow-scrolling: touch;
    padding:12px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom)); /* ✅ helps reach last card */
  }

  .exercise-card{
    background:#fff;
    border-radius:14px;
    box-shadow:0 12px 30px rgba(0,0,0,.18);
    padding:16px 16px 14px;
    margin-bottom:18px;
  }
  .exercise-card img{
    width:180px; height:180px;
    object-fit:cover;
    border-radius:10px;
    display:block;
    margin:0 auto 10px;
  }

  .exercise-topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin:0 0 10px;
  }
  .exercise-title{
    flex:1;
    text-align:center;
    font-size:18px;
    font-weight:900;
    letter-spacing:.3px;
    margin:0;
    color:#111;
  }
  .card-menu-btn{
    border:1px solid #e6e6e6;
    background:#fff;
    border-radius:12px;
    width:42px;
    height:42px;
    font-weight:950;
    font-size:18px;
    line-height:1;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    -webkit-tap-highlight-color: transparent;
  }
  .card-menu-btn:active{ transform: scale(.98); }

  .chart-wrapper{
    display:inline-block;
    width:fit-content;
    background:#fff;
    border-radius:10px;
    box-shadow:0 6px 20px rgba(0,0,0,.06);
    border:1px solid #e6e6e6;
  }
  .chart-wrapper + .chart-wrapper{ display:block; margin-top:12px; }

  .chart{
    display:grid;
    grid-template-columns:repeat(5,72px);
    grid-auto-rows:38px;
    gap:1px;
    background:#f0f0f0;
  }
  .cell{
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:13px;
    font-weight:500;
    padding:2px;
    user-select:none;
  }
  .chart-label{ font-weight:900; letter-spacing:.3px; color:#444; }

  .editable{
    background:#fafafa;
    border-bottom:1px solid #ddd;
    cursor:text;
    font-weight:800;
    min-height:38px;
  }
  .cell:active{ background:#f1f5ff; }

  .editable input{
    width:100%; height:100%;
    border:0; outline:none;
    background:transparent;
    text-align:center;
    font:inherit;
    color:inherit;
    padding:2px 6px;
    -webkit-appearance:none;
    appearance:none;
    font-size:16px;
    font-weight:900;
  }
  .editable:focus-within{
    background:#fff;
    border-bottom-color:#999;
    outline:none;
  }

  .plate{ font-weight:700; color:#444; transition:background .15s ease; }
  .plate.active{ background:#eef3ff; color:#1f3fbf; }

  @media (max-width:420px){
    .chart{ grid-template-columns:repeat(5,64px); }
  }

  #kbdDoneBar{
    position:fixed; left:0; right:0; bottom:0;
    padding:10px 12px calc(10px + env(safe-area-inset-bottom));
    background:rgba(255,255,255,.92);
    border-top:1px solid #e6e6e6;
    backdrop-filter:blur(14px);
    -webkit-backdrop-filter:blur(14px);
    display:none;
    z-index:2000;
  }
  #kbdDoneBtn{
    padding:10px 16px;
    border-radius:12px;
    border:1px solid #ddd;
    background:#fff;
    font-weight:900;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    -webkit-tap-highlight-color: transparent;
  }
  #kbdDoneBtn:active{ transform: scale(.98); }

  .actionBtn{
    padding:14px 14px;
    border-radius:14px;
    border:1px solid #ddd;
    background:#fff;
    font-weight:950;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
    box-shadow:0 10px 26px rgba(0,0,0,.10);
  }
  .actionBtn:active{ transform:scale(.99); }
  .actionBtn.primary{ border-color: rgba(31,63,191,.25); background:#eef3ff; }
  .actionBtn.danger{ border-color:#eee; background:#fafafa; color:#333; }

  #exportFallback{
    position:fixed; inset:0;
    background:rgba(0,0,0,.60);
    display:none; z-index:3000;
    padding:env(safe-area-inset-top) 12px env(safe-area-inset-bottom);
  }
  #exportFallback .box{
    max-width:680px;
    margin:24px auto;
    background:#fff;
    border-radius:18px;
    box-shadow:0 30px 80px rgba(0,0,0,.4);
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  #exportFallback .titleRow{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  #exportFallback .title{ font-weight:950; font-size:16px; color:#111; }
  #exportFallback .desc{ font-size:13px; color:#444; line-height:1.35; }
  #exportFallback .actions{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (max-width:420px){
    #exportFallback .actions{ grid-template-columns: 1fr; }
  }
  #exportTextWrap{ display:none; gap:8px; flex-direction:column; }
  #exportText{
    width:100%;
    height:260px;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size:12px;
    padding:10px;
    border-radius:12px;
    border:1px solid #ddd;
  }
  .tinyLinkBtn{
    border:0;
    background:transparent;
    color:#1f3fbf;
    font-weight:900;
    cursor:pointer;
    padding:6px 0;
    text-align:left;
  }

  #addExerciseModal{
    position:fixed; inset:0;
    background:rgba(0,0,0,.60);
    display:none; z-index:3500;
    padding:env(safe-area-inset-top) 12px env(safe-area-inset-bottom);
  }
  #addExerciseModal .box{
    max-width:680px;
    margin:24px auto;
    background:#fff;
    border-radius:18px;
    box-shadow:0 30px 80px rgba(0,0,0,.4);
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  #addExerciseModal .row{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  #addExerciseModal label{ font-weight:900; font-size:13px; }
  #addExerciseModal input, #addExerciseModal select{
    padding:12px;
    border-radius:12px;
    border:1px solid #ddd;
    font-size:16px;
    font-weight:900;
    width:100%;
    box-sizing:border-box;
  }

  #actionSheet{
    position:fixed; inset:0;
    background:rgba(0,0,0,.45);
    display:none; z-index:3600;
    padding:env(safe-area-inset-top) 12px env(safe-area-inset-bottom);
  }
  #actionSheet .sheet{
    max-width:680px;
    margin:auto;
    background:rgba(255,255,255,.92);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    border-radius:18px;
    box-shadow:0 30px 80px rgba(0,0,0,.35);
    overflow:hidden;
  }
  #actionSheet .sheetHead{
    padding:14px 14px 10px;
    border-bottom:1px solid rgba(0,0,0,.08);
  }
  #actionSheet .sheetTitle{ font-weight:950; font-size:16px; color:#111; }
  #actionSheet .sheetSub{ margin-top:4px; font-size:12px; color:#555; }
  #actionSheet .sheetBtns{ display:flex; flex-direction:column; }
  #actionSheet .sheetBtn{
    padding:16px 14px;
    border:0;
    background:transparent;
    font-weight:950;
    font-size:16px;
    text-align:left;
    cursor:pointer;
  }
  #actionSheet .sheetBtn + .sheetBtn{ border-top:1px solid rgba(0,0,0,.08); }
  #actionSheet .sheetBtn:active{ background:rgba(0,0,0,.06); }
  #actionSheet .danger{ color:#c01919; }
  #actionSheet .cancel{
    margin-top:10px;
    background:rgba(255,255,255,.92);
    border-radius:18px;
    overflow:hidden;
  }

  #toast{
    position:fixed;
    left:50%;
    bottom: calc(20px + env(safe-area-inset-bottom));
    transform: translateX(-50%);
    background: rgba(0,0,0,.82);
    color:#fff;
    padding:10px 12px;
    border-radius:999px;
    font-weight:900;
    font-size:13px;
    z-index:4000;
    display:none;
    box-shadow:0 18px 40px rgba(0,0,0,.35);
  }
</style>
</head>

<body>

<div class="thumbnail-container" onclick="openGroup('legs')">
  <img src="https://jessicaautumn.com/wp-content/uploads/2019/06/10-Minute-Workout-For-The-Perfect-Bubble-Butt.png" loading="lazy">
  <div class="label">Legs / Glutes</div>
</div>
<div class="thumbnail-container" onclick="openGroup('back')">
  <img src="https://betterme.world/articles/wp-content/uploads/2023/04/shutterstock_1654270861.jpg" loading="lazy">
  <div class="label">Back</div>
</div>
<div class="thumbnail-container" onclick="openGroup('biceps')">
  <img src="https://i.pinimg.com/736x/e4/fd/2e/e4fd2e34aec8c4f86e10fceb79fe1bed.jpg" loading="lazy">
  <div class="label">Biceps</div>
</div>
<div class="thumbnail-container" onclick="openGroup('chest')">
  <img src="https://hips.hearstapps.com/hmg-prod/images/766/articles/2017/10/benchpress-1508589156.jpg" loading="lazy">
  <div class="label">Chest</div>
</div>
<div class="thumbnail-container" onclick="openGroup('shoulders')">
  <img src="https://media.istockphoto.com/id/1370070773/photo/fitness.jpg?s=612x612&w=0&k=20&c=FjKgCTJnlLUV8V0ftf0rgsjKgUPD83hWZQURViRRBmk=" loading="lazy">
  <div class="label">Shoulders</div>
</div>
<div class="thumbnail-container" onclick="openGroup('triceps')">
  <img src="https://t4.ftcdn.net/jpg/01/70/23/39/360_F_170233939_NAVDp5d9kTWMwthTNC3ZJiwqxrKOfdUs.jpg" loading="lazy">
  <div class="label">Triceps</div>
</div>

<div class="controls">
  <button onclick="exportData()">Export</button>
  <button onclick="openAddExercise()">Add Exercise</button>
  <input type="file" id="importFile" accept="application/json" hidden>
  <button onclick="document.getElementById('importFile').click()">Import</button>
  <button onclick="resetAll()">Reset</button>
</div>

<div class="overlay" onclick="closePanel()"></div>
<div id="panel"></div>

<div id="kbdDoneBar">
  <div style="display:flex; justify-content:flex-end; gap:10px;">
    <button id="kbdDoneBtn" type="button">Done</button>
  </div>
</div>

<div id="exportFallback" onclick="closeExportFallback()">
  <div class="box" onclick="event.stopPropagation()">
    <div class="titleRow">
      <div class="title">Export Workout Data</div>
      <button class="actionBtn danger" style="padding:10px 12px; border-radius:12px;" type="button" onclick="closeExportFallback()">Close</button>
    </div>

    <div class="desc">
      Fastest: tap <b>Share</b> to save/send your <code>.json</code>. If Share isn’t available, tap <b>Copy</b>.
    </div>

    <div class="actions">
      <button id="shareBtn" class="actionBtn primary" type="button" onclick="shareExport()">Share</button>
      <button class="actionBtn" type="button" onclick="copyExportText()">Copy</button>
    </div>

    <button class="tinyLinkBtn" type="button" onclick="toggleExportDetails()">Show export text</button>

    <div id="exportTextWrap">
      <textarea id="exportText" spellcheck="false"></textarea>
    </div>
  </div>
</div>

<div id="addExerciseModal" onclick="closeAddExercise()">
  <div class="box" onclick="event.stopPropagation()">
    <div class="row">
      <div style="font-weight:950;font-size:16px;">Add Exercise</div>
      <button class="actionBtn danger" style="padding:10px 12px; border-radius:12px;"
        type="button" onclick="closeAddExercise()">Close</button>
    </div>

    <label>Muscle Group</label>
    <select id="addGroup">
      <option value="legs">Legs/Glutes</option>
      <option value="back">Back</option>
      <option value="biceps">Biceps</option>
      <option value="chest">Chest</option>
      <option value="shoulders">Shoulders</option>
      <option value="triceps">Triceps</option>
    </select>

    <label>Exercise Name</label>
    <input id="addName" type="text" placeholder="Example: Seated calf raise">

    <label>Image URL (optional)</label>
    <input id="addImg" type="url" placeholder="https://...">

    <button class="actionBtn primary" type="button" onclick="saveNewExercise()">Save Exercise</button>
  </div>
</div>

<div id="actionSheet" onclick="closeActionSheet()">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheetHead">
      <div class="sheetTitle" id="asTitle">Exercise</div>
      <div class="sheetSub" id="asSub">Exercise options</div>
    </div>

    <div class="sheetBtns">
      <button class="sheetBtn" type="button" onclick="renameExercise()">Rename</button>
      <button class="sheetBtn" type="button" onclick="changeExerciseImage()">Change image URL</button>
      <button class="sheetBtn danger" type="button" onclick="deleteExercise()">Delete exercise</button>
    </div>
  </div>

  <div class="cancel sheet" style="max-width:680px;" onclick="event.stopPropagation()">
    <button class="sheetBtn" type="button" onclick="closeActionSheet()">Cancel</button>
  </div>
</div>

<div id="toast"></div>

<script>
const DATA = {
  legs: [
    { name:'Leg curl', img:'https://www.hoistfitness.com/cdn/shop/files/RS-2408_FINISHSIDE2_resized.png' },
    { name:'Leg press', img:'https://i.ytimg.com/vi/n2ng6LCp3yk/hq720.jpg' },
    { name:'Hip Spread', img:'https://blackbearfitness.co.uk/cdn/shop/files/Untitled-design33-1_cleanup.png' },
    { name:'Hip Squeeze', img:'https://extremefitness.co.uk/wp-content/uploads/Untitled-design29.jpg' },
    { name:'Leg Extensions', img:'https://cffstrengthequipment.com/cdn/shop/products/hoist_leg_extension_rs_1401_a.1_1024x1024.jpg' },
    { name:'Booty squats', img:'https://www.shutterstock.com/image-photo/woman-training-fitness-rubber-band-260nw-2210643481.jpg' }
  ],
  back: [
    { name:'Row (triangle)', img:'https://i.ytimg.com/vi/hxdhLPCCJQI/maxresdefault.jpg' },
    { name:'Row (bar)', img:'https://i.ytimg.com/vi/9_35TQNqm7Q/hqdefault.jpg' },
    { name:'Pull down (triangle)', img:'https://dungcutheduc.vn/images/close-grip-lat-pulldown.jpg' },
    { name:'Pull down (bar)', img:'https://i.vimeocdn.com/video/867314588.webp' },
    { name:'Face pull', img:'https://i.pinimg.com/736x/f3/68/85/f3688525e50f2814a74990a1a06b4895.jpg' },
    { name:'Rear Delt Flyes', img:'https://www.buyandsellfitness.com/cdn/shop/products/Rear-Delt-Finsh_1024x1024.jpg' }
  ],
  biceps: [
    { name:'Hammer curl dumbbell', img:'https://julielohre.com/wp-content/uploads/2018/07/Bicep-Hammer-Curl.jpg' },
    { name:'Open hand curl dumbbell', img:'https://kefl.co.uk/cdn/shop/articles/best-dumbbell-exercises-for-building-muscle-148250.jpg' },
    { name:'Rope curl', img:'https://img.livestrong.com/375/cme-data/getty/d98f17ab178a4804b614028dfa95278e.jpg' },
    { name:'Drag curls', img:'https://i.ytimg.com/vi/1n_2P4OR-0Q/maxresdefault.jpg' }
  ],
  chest: [
    { name:'Machine chest press', img:'https://t4.ftcdn.net/jpg/03/00/96/39/360_F_300963984.jpg' },
    { name:'Chest flyes', img:'https://workouthealthy.com/cdn/shop/files/BS-S2PEC.webp' }
  ],
  shoulders: [
    { name:'Shoulder press', img:'https://vtasfitnesscentre.com/wp-content/uploads/2021/03/Dumbbell-Shoulder-Press.jpg' },
    { name:'Lateral raise', img:'https://images.ctfassets.net/8urtyqugdt2l/1EG31PaEzRIWNnuW9VeXcI/29ca964acdaf4d51494ca515971093f9/tile-image-how-to-do-lateral-raises.jpg' }
  ],
  triceps: [
    { name:'Rope triceps', img:'https://s3assets.skimble.com/assets/2674907/image_full.jpg' },
    { name:'Triangle tricep push down', img:'https://images.squarespace-cdn.com/tricep.jpg' },
    { name:'Dip Machine', img:'https://s3.amazonaws.com/prod.skimble/assets/1495083/image_iphone.jpg' }
  ]
};

const GROUP_LABELS = {
  legs:"Legs/Glutes",
  back:"Back",
  biceps:"Biceps",
  chest:"Chest",
  shoulders:"Shoulders",
  triceps:"Triceps"
};

const EXDB_KEY = "BSCULPT::EXERCISE_DB_V1";

function makeId(){
  return "ex_" + Date.now().toString(36) + Math.random().toString(36).slice(2);
}
function getExerciseDB(){
  try{
    const db = JSON.parse(localStorage.getItem(EXDB_KEY) || "");
    if(db && typeof db === "object") return db;
  }catch(e){}
  return null;
}
function setExerciseDB(db){
  localStorage.setItem(EXDB_KEY, JSON.stringify(db));
}
function seedExerciseDBIfMissing(){
  const existing = getExerciseDB();
  if(existing) return;

  const db = {};
  Object.keys(DATA).forEach(groupKey=>{
    db[groupKey] = (DATA[groupKey] || []).map(ex => ({ id: makeId(), name: ex.name, img: ex.img }));
  });
  setExerciseDB(db);
}
function getExercisesForGroup(groupKey){
  const db = getExerciseDB() || {};
  return (db[groupKey] || []).map(x => ({...x, custom:true}));
}
function addExerciseToGroup(groupKey, name, img){
  const db = getExerciseDB() || {};
  if(!db[groupKey]) db[groupKey] = [];
  const exists = db[groupKey].some(e => String(e.name).toLowerCase() === name.toLowerCase());
  if(exists) return { ok:false, msg:"That exercise already exists in this muscle group." };
  db[groupKey].push({ id: makeId(), name, img: img || "https://via.placeholder.com/400?text=Exercise" });
  setExerciseDB(db);
  return { ok:true };
}
function updateExercise(groupKey, exId, patch){
  const db = getExerciseDB() || {};
  const list = db[groupKey] || [];
  const item = list.find(x => x.id === exId);
  if(!item) return false;
  if(patch.name !== undefined) item.name = patch.name;
  if(patch.img !== undefined) item.img = patch.img;
  setExerciseDB(db);
  return true;
}
function deleteExerciseFromGroup(groupKey, exId){
  const db = getExerciseDB() || {};
  const list = db[groupKey] || [];
  db[groupKey] = list.filter(x => x.id !== exId);
  setExerciseDB(db);
}

function openGroup(groupKey){
  openExercises(GROUP_LABELS[groupKey] || groupKey, getExercisesForGroup(groupKey), groupKey);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}

function openExercises(groupLabel, exercises, groupKey){
  document.querySelector('.overlay').style.display='block';
  document.body.style.overflow='hidden';

  const panel=document.getElementById('panel');
  panel.classList.add('show');

  panel.innerHTML = `
    <div class="panel-header">
      <div class="panel-title">${groupLabel}</div>
      <button class="panel-close" type="button" onclick="closePanel()">Close</button>
    </div>
    <div class="panel-body" id="panelBody"></div>
  `;

  const body = document.getElementById('panelBody');

  exercises.forEach(ex=>{
    const card=document.createElement('div');
    card.className='exercise-card';

    const menuBtn =
      `<button class="card-menu-btn" type="button"
         onclick="openActionSheet(event,'${groupKey}','${ex.id}','${escapeHtml(ex.name)}')">⋯</button>`;

    card.innerHTML = `
      <img src="${ex.img}" loading="lazy">
      <div class="exercise-topbar">
        <span style="width:42px;height:42px;display:inline-block;"></span>
        <div class="exercise-title">${ex.name}</div>
        ${menuBtn}
      </div>
    `;

    ['Warm Up','1','2','3'].forEach(label=>card.appendChild(buildChart(groupLabel,ex.name,label)));
    body.appendChild(card);
  });

  wireKeyboardDone();
}

function closePanel(){
  document.querySelector('.overlay').style.display='none';
  const panel=document.getElementById('panel');
  panel.classList.remove('show');
  panel.innerHTML='';
  document.body.style.overflow='';

  const bar = document.getElementById('kbdDoneBar');
  if(bar) bar.style.display='none';
}

function safeKey(str){ return String(str).replace(/\s+/g,' ').trim(); }

function buildChart(group, ex, label){
  const key=`BSCULPT::${safeKey(group)}::${safeKey(ex)}::${safeKey(label)}`;
  const saved=JSON.parse(localStorage.getItem(key)||'{}');
  const wrapper=document.createElement('div');
  wrapper.className='chart-wrapper';

  wrapper.innerHTML=`
    <div class="chart">
      <div class="cell chart-label">${label}</div>

      <div class="cell editable" style="grid-column:2/span 2">
        <input class="rep-input" type="number" inputmode="numeric" step="1" min="0"
          placeholder="reps" value="${saved.set > 0 ? saved.set : ''}" aria-label="Reps">
      </div>

      <div class="cell editable" style="grid-column:4/span 2">
        <input class="weight-input" type="number" inputmode="decimal" step="0.5" min="0"
          placeholder="lbs" value="${saved.weight > 0 ? saved.weight : ''}" aria-label="Weight in lbs">
      </div>

      ${[45,25,10,5,2.5].map(p=>`<div class="cell plate" data-w="${p}">${p} × 0</div>`).join('')}
    </div>`;

  const repInput=wrapper.querySelector('.rep-input');
  const weightInput=wrapper.querySelector('.weight-input');
  const plates=[...wrapper.querySelectorAll('.plate')];

  function update(){
    let w=parseFloat(weightInput.value)||0, r=w;
    plates.forEach(p=>{
      const pw=+p.dataset.w;
      const c=Math.floor(r/pw); r-=c*pw;
      p.textContent=`${pw} × ${c}`;
      p.classList.toggle('active',c>0);
    });
    const reps=parseInt(repInput.value,10);
    const repsSafe = Number.isFinite(reps) ? reps : 0;
    localStorage.setItem(key,JSON.stringify({weight:w,set:repsSafe}));
  }

  repInput.oninput=update;
  weightInput.oninput=update;
  update();
  return wrapper;
}

function wireKeyboardDone(){
  const bar = document.getElementById('kbdDoneBar');
  const btn = document.getElementById('kbdDoneBtn');
  if(!bar || !btn) return;

  const inputs = document.querySelectorAll('#panel input');
  inputs.forEach(inp=>{
    inp.addEventListener('focus', ()=> bar.style.display='block');
    inp.addEventListener('blur', ()=>{
      setTimeout(()=>{
        const a=document.activeElement;
        if(!(a && a.tagName==='INPUT')) bar.style.display='none';
      }, 80);
    });
  });

  btn.onclick = ()=>{
    if(document.activeElement && document.activeElement.blur) document.activeElement.blur();
    bar.style.display='none';
  };
}

function openAddExercise(){
  document.getElementById('addName').value = "";
  document.getElementById('addImg').value = "";
  document.getElementById('addExerciseModal').style.display = "block";
  setTimeout(()=>document.getElementById('addName').focus(), 60);
}
function closeAddExercise(){
  document.getElementById('addExerciseModal').style.display = "none";
}
function saveNewExercise(){
  const groupKey = document.getElementById('addGroup').value;
  const name = (document.getElementById('addName').value || "").trim();
  const img = (document.getElementById('addImg').value || "").trim();
  if(!name){ alert("Please enter an exercise name."); return; }
  const res = addExerciseToGroup(groupKey, name, img);
  if(!res.ok){ alert(res.msg); return; }
  closeAddExercise();
  toast("Saved!");
  openGroup(groupKey);
}

let ACTION_CTX = { groupKey:null, exId:null, exName:null };

function openActionSheet(ev, groupKey, exId, exName){
  ev.stopPropagation();
  ACTION_CTX = { groupKey, exId, exName };
  document.getElementById('asTitle').textContent = exName || "Exercise";
  document.getElementById('asSub').textContent = "Exercise options";
  document.getElementById('actionSheet').style.display='block';
}
function closeActionSheet(){
  document.getElementById('actionSheet').style.display='none';
}
function renameExercise(){
  const {groupKey, exId, exName} = ACTION_CTX;
  const next = prompt("Rename exercise:", exName || "");
  if(next === null) return;
  const name = next.trim();
  if(!name){ alert("Name cannot be empty."); return; }
  const list = getExercisesForGroup(groupKey);
  const dup = list.some(x => x.id !== exId && String(x.name).toLowerCase() === name.toLowerCase());
  if(dup){ alert("That name already exists in this group."); return; }
  updateExercise(groupKey, exId, { name });
  closeActionSheet();
  toast("Renamed!");
  openGroup(groupKey);
}
function changeExerciseImage(){
  const {groupKey, exId} = ACTION_CTX;
  const list = getExercisesForGroup(groupKey);
  const item = list.find(x => x.id === exId);
  const current = item ? item.img : "";
  const next = prompt("Paste image URL:", current || "");
  if(next === null) return;
  const url = next.trim();
  if(!url){ alert("Image URL cannot be empty."); return; }
  updateExercise(groupKey, exId, { img: url });
  closeActionSheet();
  toast("Updated image!");
  openGroup(groupKey);
}
function deleteExercise(){
  const {groupKey, exId, exName} = ACTION_CTX;
  const ok = confirm(`Delete "${exName}"?`);
  if(!ok) return;
  deleteExerciseFromGroup(groupKey, exId);
  closeActionSheet();
  toast("Deleted!");
  openGroup(groupKey);
}

const GROUP_ORDER=[
  {key:'legs',name:'Legs/Glutes'},
  {key:'back',name:'Back'},
  {key:'biceps',name:'Biceps'},
  {key:'chest',name:'Chest'},
  {key:'shoulders',name:'Shoulders'},
  {key:'triceps',name:'Triceps'}
];
const CHART_ORDER=['Warm Up','1','2','3'];

let LAST_EXPORT_JSON = "";
let LAST_EXPORT_FILE = null;

function exportData(){
  const out={meta:{app:'Babe Sculpting',version:6,exportedAt:new Date().toISOString()},groups:[]};
  out.exerciseDB = getExerciseDB();

  GROUP_ORDER.forEach(g=>{
    const gb={group:g.name,exercises:[]};
    const allExercises = getExercisesForGroup(g.key);

    allExercises.forEach(ex=>{
      const eb={name:ex.name,charts:[]};
      CHART_ORDER.forEach(l=>{
        const k=`BSCULPT::${safeKey(g.name)}::${safeKey(ex.name)}::${safeKey(l)}`;
        const s=JSON.parse(localStorage.getItem(k)||'{}');
        eb.charts.push({label:l,set:(s.set ?? 0),weight:(s.weight ?? 0)});
      });
      gb.exercises.push(eb);
    });

    out.groups.push(gb);
  });

  const json = JSON.stringify(out,null,2);
  LAST_EXPORT_JSON = json;

  try{
    LAST_EXPORT_FILE = new File([json], 'babe_sculpting_data.json', { type:'application/json' });
  }catch(e){
    LAST_EXPORT_FILE = null;
  }

  try{
    const blob=new Blob([json],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='babe_sculpting_data.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }catch(e){}

  const ua = navigator.userAgent || "";
  const isiOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
  if(isiOS){
    showExportFallback(json);
  }else{
    toast("Downloaded (if supported).");
  }
}

function showExportFallback(json){
  const modal=document.getElementById('exportFallback');
  const textarea=document.getElementById('exportText');
  const wrap=document.getElementById('exportTextWrap');
  const shareBtn=document.getElementById('shareBtn');

  textarea.value=json;
  wrap.style.display='none';

  const canShare = !!(navigator.share);
  shareBtn.disabled = !canShare;
  shareBtn.style.opacity = canShare ? '1' : '.55';

  modal.style.display='block';
  toast(canShare ? "Tap Share to save/send the .json" : "Tap Copy to export");
}
function closeExportFallback(){ document.getElementById('exportFallback').style.display='none'; }
function toggleExportDetails(){
  const wrap=document.getElementById('exportTextWrap');
  const btn=document.querySelector('#exportFallback .tinyLinkBtn');
  const isOpen = wrap.style.display === 'flex';
  wrap.style.display = isOpen ? 'none' : 'flex';
  btn.textContent = isOpen ? 'Show export text' : 'Hide export text';
  if(!isOpen){
    const t=document.getElementById('exportText');
    setTimeout(()=>{ t.focus(); t.select(); }, 50);
  }
}
async function shareExport(){
  if(!navigator.share){ toast("Share not available. Use Copy."); return; }
  try{
    if(LAST_EXPORT_FILE && navigator.canShare && navigator.canShare({ files:[LAST_EXPORT_FILE] })){
      await navigator.share({ title:'Babe Sculpting Export', text:'Workout export (.json)', files:[LAST_EXPORT_FILE] });
      toast("Shared!");
      return;
    }
    await navigator.share({ title:'Babe Sculpting Export', text: LAST_EXPORT_JSON || '' });
    toast("Shared!");
  }catch(err){
    if(String(err && err.name) !== 'AbortError') toast("Share failed. Use Copy.");
  }
}
async function copyExportText(){
  const textarea=document.getElementById('exportText');
  const text=textarea.value;
  if(!text){ toast("Nothing to copy."); return; }

  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
      toast("Copied!");
      return;
    }
  }catch(e){}

  const wrap=document.getElementById('exportTextWrap');
  const wasHidden = wrap.style.display === 'none';
  if(wasHidden) wrap.style.display='flex';
  textarea.focus(); textarea.select();
  document.execCommand('copy');
  if(wasHidden) wrap.style.display='none';
  toast("Copied!");
}

document.getElementById('importFile').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const d=JSON.parse(r.result);

      if(d.exerciseDB && typeof d.exerciseDB === "object"){
        setExerciseDB(d.exerciseDB);
      }

      if(Array.isArray(d.groups)){
        d.groups.forEach(g=>g.exercises.forEach(ex=>ex.charts.forEach(c=>{
          const k=`BSCULPT::${safeKey(g.group)}::${safeKey(ex.name)}::${safeKey(c.label)}`;
          localStorage.setItem(k,JSON.stringify({weight:(c.weight ?? 0),set:(c.set ?? 0)}));
        })));
      }else{
        Object.keys(d).forEach(k=>k.startsWith('BSCULPT::')&&localStorage.setItem(k,JSON.stringify(d[k])));
      }

      alert('Import complete.');
      if(document.getElementById('panel').classList.contains('show')) closePanel();
    }catch(err){
      alert('Import failed. Please select a valid export JSON.');
    }
  };
  r.readAsText(f);
  e.target.value='';
};

function resetAll(){
  const ok = confirm('Reset all saved reps/weights AND the editable exercise list on this device? (Export first if you want a backup)');
  if(!ok) return;

  const keys=[];
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k && k.startsWith('BSCULPT::')) keys.push(k);
  }
  keys.forEach(k=>localStorage.removeItem(k));

  localStorage.removeItem(EXDB_KEY);
  seedExerciseDBIfMissing();

  alert('All data cleared (defaults restored).');
}

let toastTimer=null;
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;
  el.style.display='block';
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{ el.style.display='none'; }, 1400);
}

window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape') closePanel();
});

seedExerciseDBIfMissing();
</script>
</body>
</html>