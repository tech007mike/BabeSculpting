<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Babe Sculpting</title>

<style>
  :root{
    --gap: 20px;
    --cols: 3;

    --bg0: #0b0f14;
    --bg1: #0f1722;

    --text: rgba(255,255,255,.92);
    --gold2:#f2deaa;
    --danger:#ff5c6e;

    --shadow: 0 16px 45px rgba(0,0,0,.55);
    --shadow2: 0 10px 28px rgba(0,0,0,.45);
    --radius: 14px;
  }

  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,sans-serif;
    color:var(--text);
    padding:20px;

    background:
      radial-gradient(1200px 900px at 15% 10%, rgba(61,214,198,.12), transparent 55%),
      radial-gradient(900px 700px at 85% 20%, rgba(215,180,106,.12), transparent 52%),
      radial-gradient(900px 700px at 55% 95%, rgba(255,255,255,.06), transparent 55%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    display:flex;
    flex-wrap:wrap;
    gap:var(--gap);
    justify-content:space-around;
  }

  #groupsRoot{
    width:100%;
    display:grid;
    grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
    gap:var(--gap);
    justify-items:stretch;
    align-items:stretch;
  }

  .thumbnail-container{
    position:relative;
    width:100%;
    aspect-ratio:1;
    border-radius:var(--radius);
    overflow:hidden;
    cursor:pointer;

    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.10);
    box-shadow: var(--shadow2);
    transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;

    user-select:none;
    -webkit-user-select:none;
    -webkit-touch-callout:none;
    touch-action:manipulation;
  }

  .thumbnail-container:hover{
    transform: translateY(-3px) scale(1.03);
    border-color: rgba(215,180,106,.35);
    box-shadow: 0 18px 52px rgba(0,0,0,.60);
  }

  .thumbnail-container img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    filter: saturate(1.05) contrast(1.05);
    transform: scale(1.02);
  }

  .thumbnail-container::before{
    content:"";
    position:absolute;
    inset:0;
    background:
      linear-gradient(135deg, rgba(255,255,255,.12), transparent 35%),
      radial-gradient(500px 500px at 20% 20%, rgba(215,180,106,.10), transparent 55%);
    pointer-events:none;
    mix-blend-mode: screen;
    opacity:.55;
  }

  .label{
    position:absolute;
    left:12px;
    right:12px;
    bottom:12px;

    padding:10px 10px;
    border-radius:12px;

    background:
      linear-gradient(180deg, rgba(12,16,22,.65), rgba(12,16,22,.45));
    border:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);

    text-align:center;
    font-weight:900;
    letter-spacing:.35px;

    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;

    font-size:18px;
    line-height:1.1;

    box-shadow: 0 10px 26px rgba(0,0,0,.45);
  }

  .tile-actions{
    position:absolute;
    top:10px;
    right:10px;
    display:flex;
    gap:8px;
    z-index:5;

    opacity:0;
    pointer-events:none;
    transform:translateY(-6px);
    transition:opacity .15s ease, transform .15s ease;
  }
  .thumbnail-container.show-actions .tile-actions{
    opacity:1;
    pointer-events:auto;
    transform:translateY(0);
  }

  .icon-btn{
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    color: var(--text);
    border-radius:12px;
    padding:10px 11px;
    font-weight:900;
    cursor:pointer;
    box-shadow: 0 10px 24px rgba(0,0,0,.45);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .icon-btn:active{ transform:scale(.98); }
  .icon-btn.danger{
    border-color: rgba(255,92,110,.35);
    background: linear-gradient(180deg, rgba(255,92,110,.18), rgba(255,92,110,.08));
  }

  .controls{
    width:100%;
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:12px;
    margin-top:10px;
  }

  .controls button{
    padding:11px 16px;
    font-size:15px;
    font-weight:900;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    color: var(--text);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    cursor:pointer;
    box-shadow: 0 12px 30px rgba(0,0,0,.45);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .controls button:active{ transform:scale(.99); }

  .grid-btn{
    border-color: rgba(61,214,198,.35) !important;
    box-shadow: 0 12px 30px rgba(61,214,198,.10), 0 12px 30px rgba(0,0,0,.45);
  }

  .reset-btn{
    border-color: rgba(255,92,110,.35) !important;
    background: linear-gradient(180deg, rgba(255,92,110,.18), rgba(255,92,110,.08)) !important;
  }

  .overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.68);
    z-index:999;
    display:none;
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }

  #panel{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    z-index:1000;
    width:min(560px, 92vw);
    max-height:86vh;
    overflow-y:auto;
    padding:16px;
    border-radius:16px;
    background:transparent;
  }

  .panel-header{
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    border: 1px solid rgba(255,255,255,.12);
    border-radius:16px;
    box-shadow: var(--shadow);
    padding:12px;
    margin-bottom:14px;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  .panel-title{
    font-size:18px;
    font-weight:950;
    text-align:center;
    margin:0 0 10px;
    letter-spacing:.35px;
  }

  .panel-actions{
    display:flex;
    gap:10px;
  }
  .panel-actions button{
    flex:1;
    padding:11px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    color: var(--text);
    font-weight:950;
    cursor:pointer;
    box-shadow: 0 12px 28px rgba(0,0,0,.45);
  }
  .panel-actions .danger{
    border-color: rgba(255,92,110,.35);
    background: linear-gradient(180deg, rgba(255,92,110,.18), rgba(255,92,110,.08));
  }

  .exercise-card{
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    border: 1px solid rgba(255,255,255,.12);
    border-radius:16px;
    box-shadow: var(--shadow);
    padding:16px 16px 14px;
    margin-bottom:18px;
    position:relative;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  .exercise-card img{
    width:180px;
    height:180px;
    object-fit:cover;
    border-radius:14px;
    display:block;
    margin:0 auto 10px;
    border:1px solid rgba(255,255,255,.12);
    box-shadow: 0 14px 34px rgba(0,0,0,.55);
  }

  .exercise-title{
    text-align:center;
    font-size:18px;
    font-weight:950;
    letter-spacing:.35px;
    margin:0 0 10px;
  }

  .exercise-actions{
    display:flex;
    gap:10px;
    margin:10px 0 6px;
  }
  .exercise-actions button{
    flex:1;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    color: var(--text);
    font-weight:950;
    cursor:pointer;
    box-shadow: 0 12px 28px rgba(0,0,0,.45);
  }
  .exercise-actions .danger{
    border-color: rgba(255,92,110,.35);
    background: linear-gradient(180deg, rgba(255,92,110,.18), rgba(255,92,110,.08));
  }

  .chart-wrapper{
    display:inline-block;
    width:fit-content;
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    border-radius:14px;
    box-shadow: 0 14px 34px rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.12);
    overflow:hidden;
  }
  .chart-wrapper + .chart-wrapper{ display:block; margin-top:12px; }

  .chart{
    display:grid;
    grid-template-columns:repeat(5,72px);
    grid-auto-rows:38px;
    gap:1px;
    background: rgba(255,255,255,.06);
  }

  .cell{
    background: rgba(12,16,22,.70);
    color: var(--text);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:13px;
    font-weight:650;
    padding:2px;
    user-select:none;
  }

  .chart-label{
    font-weight:950;
    letter-spacing:.35px;
    color: var(--gold2);
    background: linear-gradient(180deg, rgba(215,180,106,.18), rgba(12,16,22,.70));
  }

  .editable{
    background: rgba(255,255,255,.06);
    border-bottom: 1px solid rgba(255,255,255,.14);
    cursor:text;
    font-weight:850;
  }
  .editable input{
    width:100%;
    height:100%;
    border:0;
    outline:none;
    background:transparent;
    text-align:center;
    font:inherit;
    color: var(--text);
    padding:2px 6px;
    -webkit-appearance:none;
    appearance:none;
  }
  .editable:focus-within{
    background: rgba(255,255,255,.10);
    border-bottom-color: rgba(61,214,198,.55);
    outline:none;
  }

  .plate{
    font-weight:850;
    color: rgba(255,255,255,.82);
    transition:background .15s ease, color .15s ease;
  }
  .plate.active{
    background: linear-gradient(180deg, rgba(61,214,198,.16), rgba(215,180,106,.12));
    color: #ffffff;
  }

  .modal-overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.68);
    z-index:3000;
    display:none;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  .modal{
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    z-index:3001;
    width:min(560px, 92vw);
    background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    box-shadow: var(--shadow);
    padding:14px;
    display:none;
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
  }
  .modal h3{
    margin:6px 0 10px;
    font-size:16px;
    font-weight:950;
    letter-spacing:.25px;
  }
  .modal .row{
    display:flex;
    gap:10px;
    margin:10px 0;
  }
  .modal input{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(12,16,22,.55);
    color: var(--text);
    font-weight:800;
    font-size:14px;
    outline:none;
  }
  .modal input:focus{
    border-color: rgba(61,214,198,.55);
    box-shadow: 0 0 0 3px rgba(61,214,198,.14);
  }
  .modal input[type="file"]{
    padding:10px;
    font-size:13px;
    font-weight:850;
    cursor:pointer;
  }
  .modal .hint{
    font-size:12px;
    opacity:.82;
    line-height:1.25;
    margin-top:2px;
  }
  .modal .actions{
    display:flex;
    gap:10px;
    margin-top:10px;
  }
  .modal .actions button{
    flex:1;
    padding:11px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    color: var(--text);
    font-weight:950;
    cursor:pointer;
    box-shadow: 0 12px 28px rgba(0,0,0,.45);
  }
  .modal .actions .danger{
    border-color: rgba(255,92,110,.35);
    background: linear-gradient(180deg, rgba(255,92,110,.18), rgba(255,92,110,.08));
  }

  /* ===== Group List Sort UI ===== */
  .gl-toolbar{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin:8px 0 10px;
  }
  .gl-pill{
    flex:1;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    color: var(--text);
    font-weight:950;
    cursor:pointer;
    box-shadow: 0 10px 24px rgba(0,0,0,.45);
    text-align:center;
    user-select:none;
  }
  .gl-pill.active{
    border-color: rgba(61,214,198,.45);
    box-shadow: 0 10px 24px rgba(61,214,198,.12), 0 10px 24px rgba(0,0,0,.45);
  }
  .gl-list{
    display:flex;
    flex-direction:column;
    gap:10px;
    max-height:58vh;
    overflow:auto;
    padding-right:2px;
  }
  .gl-item{
    display:flex;
    gap:10px;
    align-items:center;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(12,16,22,.55);
    border-radius:14px;
    padding:10px;
    box-shadow: 0 10px 22px rgba(0,0,0,.45);
  }
  .gl-item .name{
    flex:1;
    font-weight:950;
    letter-spacing:.2px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .gl-move{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .gl-move button{
    width:44px;
    padding:10px 0;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    color: var(--text);
    font-weight:950;
    cursor:pointer;
    box-shadow: 0 10px 22px rgba(0,0,0,.45);
  }
  .gl-move button:disabled{
    opacity:.35;
    cursor:not-allowed;
  }

  @media (max-width:420px){
    .chart{ grid-template-columns:repeat(5,64px); }
  }
</style>
</head>

<body>

<div id="groupsRoot"></div>

<div class="controls">
  <button onclick="addMuscleGroup()">+ Add Muscle Group</button>
  <button onclick="openGroupList()">Muscle Group List</button>
  <button class="grid-btn" id="gridToggleBtn" onclick="toggleGrid()">Grid: 3 Across</button>
  <button onclick="exportData()">Export</button>
  <input type="file" id="importFile" accept="application/json" hidden>
  <button onclick="document.getElementById('importFile').click()">Import</button>
  <button class="reset-btn" onclick="resetBabeSculpting()">‚ö†Ô∏è RESET WORKOUT DATA ‚ö†Ô∏è</button>
</div>

<div class="overlay" onclick="closePanel()"></div>
<div id="panel"></div>

<div id="modalOverlay" class="modal-overlay" onclick="closeModal()"></div>
<div id="modal" class="modal" role="dialog" aria-modal="true"></div>

<script>
/* =======================
   STORAGE + DEFAULT DATA
======================= */
const APP_KEY = 'BSCULPT::APPDATA::v1';
const KEY_PREFIX = 'BSCULPT::';
const CHART_ORDER = ['Warm Up','1','2','3'];
const LONG_PRESS_MS = 550;
const GRID_KEY = 'BSCULPT::GRIDCOLS::v1';

function uid(){
  return 'g_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function defaultAppData(){
  return {
    version: 1,
    groups: [
      {
        id: uid(),
        name: 'Legs/Glutes',
        img: 'https://jessicaautumn.com/wp-content/uploads/2019/06/10-Minute-Workout-For-The-Perfect-Bubble-Butt.png',
        exercises: [
          { id: uid(), name:'Leg curl', img:'https://www.hoistfitness.com/cdn/shop/files/RS-2408_FINISHSIDE2_resized.png' },
          { id: uid(), name:'Leg press', img:'https://i.ytimg.com/vi/n2ng6LCp3yk/hq720.jpg' },
          { id: uid(), name:'Hip Spread', img:'https://blackbearfitness.co.uk/cdn/shop/files/Untitled-design33-1_cleanup.png' },
          { id: uid(), name:'Hip Squeeze', img:'https://extremefitness.co.uk/wp-content/uploads/Untitled-design29.jpg' },
          { id: uid(), name:'Leg Extensions', img:'https://cffstrengthequipment.com/cdn/shop/products/hoist_leg_extension_rs_1401_a.1_1024x1024.jpg' },
          { id: uid(), name:'Booty squats', img:'https://www.shutterstock.com/image-photo/woman-training-fitness-rubber-band-260nw-2210643481.jpg' }
        ]
      },
      {
        id: uid(),
        name: 'Back',
        img: 'https://betterme.world/articles/wp-content/uploads/2023/04/shutterstock_1654270861.jpg',
        exercises: [
          { id: uid(), name:'Row (triangle)', img:'https://i.ytimg.com/vi/hxdhLPCCJQI/maxresdefault.jpg' },
          { id: uid(), name:'Row (bar)', img:'https://i.ytimg.com/vi/9_35TQNqm7Q/hqdefault.jpg' },
          { id: uid(), name:'Pull down (triangle)', img:'https://dungcutheduc.vn/images/close-grip-lat-pulldown.jpg' },
          { id: uid(), name:'Pull down (bar)', img:'https://i.vimeocdn.com/video/867314588.webp' },
          { id: uid(), name:'Face pull', img:'https://i.pinimg.com/736x/f3/68/85/f3688525e50f2814a74990a1a06b4895.jpg' },
          { id: uid(), name:'Rear Delt Flyes', img:'https://www.buyandsellfitness.com/cdn/shop/products/Rear-Delt-Finsh_1024x1024.jpg' }
        ]
      },
      {
        id: uid(),
        name: 'Biceps',
        img: 'https://i.pinimg.com/736x/e4/fd/2e/e4fd2e34aec8c4f86e10fceb79fe1bed.jpg',
        exercises: [
          { id: uid(), name:'Hammer curl dumbbell', img:'https://julielohre.com/wp-content/uploads/2018/07/Bicep-Hammer-Curl.jpg' },
          { id: uid(), name:'Open hand curl dumbbell', img:'https://kefl.co.uk/cdn/shop/articles/best-dumbbell-exercises-for-building-muscle-148250.jpg' },
          { id: uid(), name:'Rope curl', img:'https://img.livestrong.com/375/cme-data/getty/d98f17ab178a4804b614028dfa95278e.jpg' },
          { id: uid(), name:'Drag curls', img:'https://i.ytimg.com/vi/1n_2P4OR-0Q/maxresdefault.jpg' }
        ]
      },
      {
        id: uid(),
        name: 'Chest',
        img: 'https://hips.hearstapps.com/hmg-prod/images/766/articles/2017/10/benchpress-1508589156.jpg',
        exercises: [
          { id: uid(), name:'Machine chest press', img:'https://t4.ftcdn.net/jpg/03/00/96/39/360_F_300963984.jpg' },
          { id: uid(), name:'Chest flyes', img:'https://workouthealthy.com/cdn/shop/files/BS-S2PEC.webp' }
        ]
      },
      {
        id: uid(),
        name: 'Shoulders',
        img: 'https://media.istockphoto.com/id/1370070773/photo/fitness.jpg?s=612x612&w=0&k=20&c=FjKgCTJnlLUV8V0ftf0rgsjKgUPD83hWZQURViRRBmk=',
        exercises: [
          { id: uid(), name:'Shoulder press', img:'https://vtasfitnesscentre.com/wp-content/uploads/2021/03/Dumbbell-Shoulder-Press.jpg' },
          { id: uid(), name:'Lateral raise', img:'https://images.ctfassets.net/8urtyqugdt2l/1EG31PaEzRIWNnuW9VeXcI/29ca964acdaf4d51494ca515971093f9/tile-image-how-to-do-lateral-raises.jpg' }
        ]
      },
      {
        id: uid(),
        name: 'Triceps',
        img: 'https://t4.ftcdn.net/jpg/01/70/23/39/360_F_170233939_NAVDp5d9kTWMwthTNC3ZJiwqxrKOfdUs.jpg',
        exercises: [
          { id: uid(), name:'Rope triceps', img:'https://s3assets.skimble.com/assets/2674907/image_full.jpg' },
          { id: uid(), name:'Triangle tricep push down', img:'https://images.squarespace-cdn.com/tricep.jpg' },
          { id: uid(), name:'Dip Machine', img:'https://s3.amazonaws.com/prod.skimble/assets/1495083/image_iphone.jpg' }
        ]
      }
    ]
  };
}

function loadAppData(){
  try{
    const raw = localStorage.getItem(APP_KEY);
    if(!raw) {
      const d = defaultAppData();
      localStorage.setItem(APP_KEY, JSON.stringify(d));
      return d;
    }
    const parsed = JSON.parse(raw);
    if(!parsed || !Array.isArray(parsed.groups)) throw new Error('bad');
    return parsed;
  }catch{
    const d = defaultAppData();
    localStorage.setItem(APP_KEY, JSON.stringify(d));
    return d;
  }
}
function saveAppData(data){ localStorage.setItem(APP_KEY, JSON.stringify(data)); }

let APP = loadAppData();
let CURRENT_GROUP_ID = null;

/* =======================
   GRID TOGGLE (1/2/3)
======================= */
function getGridCols(){
  const n = parseInt(localStorage.getItem(GRID_KEY) || '3', 10);
  return [1,2,3].includes(n) ? n : 3;
}
function applyGridCols(n){
  const cols = [1,2,3].includes(n) ? n : 3;
  document.documentElement.style.setProperty('--cols', String(cols));
  localStorage.setItem(GRID_KEY, String(cols));
  const btn = document.getElementById('gridToggleBtn');
  if(btn) btn.textContent = `Grid: ${cols} Across`;
  queueLabelFit();
}
function toggleGrid(){
  const cur = getGridCols();
  const next = cur === 3 ? 1 : cur + 1;
  applyGridCols(next);
}

/* =======================
   LABEL AUTO-FIT
======================= */
let fitQueued = false;
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function queueLabelFit(){
  if(fitQueued) return;
  fitQueued = true;
  requestAnimationFrame(()=>{
    fitQueued = false;
    fitAllGroupLabels();
  });
}

function fitLabelFont(labelEl){
  if(!labelEl) return;
  const tile = labelEl.closest('.thumbnail-container');
  if(!tile) return;

  const tileW = tile.clientWidth || 200;
  const textLen = (labelEl.textContent || '').trim().length;

  const baseMax = clamp(Math.floor(tileW / 10), 14, 24);
  const lengthPenalty = clamp(Math.floor((textLen - 10) / 4), 0, 6);
  const maxPx = clamp(baseMax - lengthPenalty, 12, 24);
  const minPx = 10;

  labelEl.style.fontSize = maxPx + 'px';
  let size = maxPx;
  while(size > minPx && labelEl.scrollWidth > labelEl.clientWidth){
    size -= 1;
    labelEl.style.fontSize = size + 'px';
  }
}

function fitAllGroupLabels(){
  document.querySelectorAll('#groupsRoot .thumbnail-container .label')
    .forEach(fitLabelFont);
}
window.addEventListener('resize', queueLabelFit);

/* =======================
   LONG-PRESS HELPERS
======================= */
function hideAllGroupActions(){
  document.querySelectorAll('.thumbnail-container.show-actions')
    .forEach(el => el.classList.remove('show-actions'));
}

document.addEventListener('click', (e)=>{
  if(e.target.closest('.tile-actions')) return;
  const inTile = e.target.closest('.thumbnail-container');
  if(!inTile) hideAllGroupActions();
});

document.addEventListener('contextmenu', (e)=>{
  if(e.target.closest('.thumbnail-container')) e.preventDefault();
}, {passive:false});

function attachLongPressHandlers(tile, groupId){
  let timer = null;

  function startPress(){
    clearTimeout(timer);
    timer = setTimeout(()=>{
      hideAllGroupActions();
      tile.classList.add('show-actions');
      tile.style.transform = 'translateY(-2px) scale(1.02)';
      setTimeout(()=>{ tile.style.transform=''; }, 140);
    }, LONG_PRESS_MS);
  }
  function endPress(){ clearTimeout(timer); }

  tile.addEventListener('touchstart', startPress, {passive:true});
  tile.addEventListener('touchend', endPress, {passive:true});
  tile.addEventListener('touchmove', endPress, {passive:true});
  tile.addEventListener('touchcancel', endPress, {passive:true});

  tile.addEventListener('mousedown', startPress);
  tile.addEventListener('mouseup', endPress);
  tile.addEventListener('mouseleave', endPress);

  tile.addEventListener('click', (e)=>{
    if(e.target.closest('.tile-actions')) return;

    if(tile.classList.contains('show-actions')){
      tile.classList.remove('show-actions');
      e.preventDefault();
      e.stopPropagation();
      return;
    }
    openGroupPanel(groupId);
  });
}

/* =======================
   RENDER GROUP TILES
======================= */
function escapeHtml(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

/* ‚úÖ NEW: grid render uses "display order" based on sort mode */
function getDisplayedGroups(){
  const mode = getGroupSortMode();
  if(mode === 'alpha'){
    return [...APP.groups].sort((a,b)=>String(a.name).localeCompare(String(b.name)));
  }
  return [...APP.groups];
}

function renderGroups(){
  const root = document.getElementById('groupsRoot');
  root.innerHTML = '';

  getDisplayedGroups().forEach(g=>{
    const tile = document.createElement('div');
    tile.className = 'thumbnail-container';

    tile.innerHTML = `
      <div class="tile-actions">
        <button class="icon-btn" title="Edit group"
          onclick="event.stopPropagation(); editMuscleGroup('${g.id}')">‚úé</button>
        <button class="icon-btn danger" title="Delete group"
          onclick="event.stopPropagation(); deleteMuscleGroup('${g.id}')">üóë</button>
      </div>
      <img src="${g.img || ''}" alt="">
      <div class="label">${escapeHtml(g.name)}</div>
    `;

    const img = tile.querySelector('img');
    if(img){
      img.addEventListener('load', queueLabelFit, {once:true});
      img.addEventListener('error', queueLabelFit, {once:true});
    }

    attachLongPressHandlers(tile, g.id);
    root.appendChild(tile);
  });

  queueLabelFit();
}

/* =======================
   GROUP PANEL
======================= */
function openGroupPanel(groupId){
  CURRENT_GROUP_ID = groupId;
  const g = APP.groups.find(x=>x.id === groupId);
  if(!g) return;

  document.querySelector('.overlay').style.display='block';
  const panel = document.getElementById('panel');
  panel.innerHTML = '';

  const header = document.createElement('div');
  header.className = 'panel-header';
  header.innerHTML = `
    <div class="panel-title">${escapeHtml(g.name)}</div>
    <div class="panel-actions">
      <button onclick="addExercise('${g.id}')">+ Add Exercise</button>
      <button class="danger" onclick="closePanel()">Close</button>
    </div>
  `;
  panel.appendChild(header);

  g.exercises.forEach(ex=>{
    const card=document.createElement('div');
    card.className='exercise-card';
    card.innerHTML=`
      <img src="${ex.img || ''}" alt="">
      <div class="exercise-title">${escapeHtml(ex.name)}</div>
      <div class="exercise-actions">
        <button onclick="editExercise('${g.id}','${ex.id}')">Edit</button>
        <button class="danger" onclick="deleteExercise('${g.id}','${ex.id}')">Delete</button>
      </div>
    `;
    CHART_ORDER.forEach(label=>card.appendChild(buildChart(g.name, ex.name, label)));
    panel.appendChild(card);
  });
}

function closePanel(){
  document.querySelector('.overlay').style.display='none';
  document.getElementById('panel').innerHTML='';
  CURRENT_GROUP_ID = null;
}

/* =======================
   WORKOUT ENTRY CHART
======================= */
function safeKey(str){ return String(str).replace(/\s+/g,' ').trim(); }

function buildChart(groupName, exName, label){
  const key=`${KEY_PREFIX}${safeKey(groupName)}::${safeKey(exName)}::${safeKey(label)}`;
  const saved=JSON.parse(localStorage.getItem(key)||'{}');

  const wrapper=document.createElement('div');
  wrapper.className='chart-wrapper';

  wrapper.innerHTML=`
    <div class="chart">
      <div class="cell chart-label">${label}</div>

      <div class="cell editable" style="grid-column:2/span 2">
        <input
          class="rep-input"
          type="number"
          inputmode="numeric"
          step="1"
          min="0"
          placeholder="reps"
          value="${saved.set > 0 ? saved.set : ''}"
        >
      </div>

      <div class="cell editable" style="grid-column:4/span 2">
        <input
          class="weight-input"
          type="number"
          inputmode="decimal"
          step="0.5"
          min="0"
          placeholder="lbs"
          value="${saved.weight > 0 ? saved.weight : ''}"
        >
      </div>

      ${[45,25,10,5,2.5].map(p=>`<div class="cell plate" data-w="${p}">${p} √ó 0</div>`).join('')}
    </div>`;

  const repInput=wrapper.querySelector('.rep-input');
  const weightInput=wrapper.querySelector('.weight-input');
  const plates=[...wrapper.querySelectorAll('.plate')];

  function update(){
    let w=parseFloat(weightInput.value)||0, r=w;

    plates.forEach(p=>{
      const pw=+p.dataset.w;
      const c=Math.floor(r/pw); r-=c*pw;
      p.textContent=`${pw} √ó ${c}`;
      p.classList.toggle('active',c>0);
    });

    const reps=parseInt(repInput.value);
    const repsSafe = Number.isFinite(reps) ? reps : 0;
    localStorage.setItem(key, JSON.stringify({weight:w,set:repsSafe}));
  }

  repInput.oninput=update;
  weightInput.oninput=update;
  update();
  return wrapper;
}

/* =======================
   MODAL HELPERS
======================= */
function openModal(html){
  document.getElementById('modal').innerHTML = html;
  document.getElementById('modalOverlay').style.display = 'block';
  document.getElementById('modal').style.display = 'block';
}
function closeModal(){
  document.getElementById('modalOverlay').style.display = 'none';
  document.getElementById('modal').style.display = 'none';
  document.getElementById('modal').innerHTML = '';
}
function val(id){ return (document.getElementById(id)?.value ?? '').trim(); }
function fileEl(id){ return document.getElementById(id); }

function readFileAsDataURL(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(String(r.result || ''));
    r.onerror = ()=> reject(new Error('File read error'));
    r.readAsDataURL(file);
  });
}

/* =======================
   GROUP LIST / SORT
======================= */
const GROUP_SORT_MODE_KEY = 'BSCULPT::GROUPSORTMODE::v1';
function getGroupSortMode(){
  const m = localStorage.getItem(GROUP_SORT_MODE_KEY) || 'user';
  return (m === 'alpha' || m === 'user') ? m : 'user';
}

/* ‚úÖ FIX: alphabetical now updates grid immediately by changing sort mode + re-rendering grid */
function setGroupSortMode(mode){
  localStorage.setItem(GROUP_SORT_MODE_KEY, mode === 'alpha' ? 'alpha' : 'user');
  openGroupList();     // refresh pills/list UI
  renderGroups();      // ‚úÖ refresh grid itself
}

function openGroupList(){
  const html = `
    <h3>Muscle Groups</h3>

    <div class="gl-toolbar">
      <div class="gl-pill ${getGroupSortMode()==='user' ? 'active':''}" onclick="setGroupSortMode('user')">User Order</div>
      <div class="gl-pill ${getGroupSortMode()==='alpha' ? 'active':''}" onclick="setGroupSortMode('alpha')">Alphabetical</div>
    </div>

    <div class="hint">In <b>User Order</b>, use ‚ñ≤‚ñº to reorder. Alphabetical instantly sorts the grid.</div>

    <div id="groupListBody" class="gl-list"></div>

    <div class="actions" style="margin-top:12px;">
      <button onclick="closeModal()">Close</button>
      <button onclick="applyGroupListChanges()">Done</button>
    </div>
  `;
  openModal(html);
  renderGroupListBody();
}

function renderGroupListBody(){
  const body = document.getElementById('groupListBody');
  if(!body) return;

  const mode = getGroupSortMode();
  const list = (mode === 'alpha')
    ? [...APP.groups].sort((a,b)=>String(a.name).localeCompare(String(b.name)))
    : [...APP.groups];

  body.innerHTML = '';

  list.forEach((g, idx)=>{
    const canMove = (mode === 'user');
    const item = document.createElement('div');
    item.className = 'gl-item';
    item.innerHTML = `
      <div class="name">${escapeHtml(g.name)}</div>
      <div class="gl-move" style="${canMove ? '' : 'display:none'}">
        <button ${idx===0 ? 'disabled':''} onclick="moveGroupInUserOrder('${g.id}', -1)">‚ñ≤</button>
        <button ${idx===list.length-1 ? 'disabled':''} onclick="moveGroupInUserOrder('${g.id}', 1)">‚ñº</button>
      </div>
    `;
    body.appendChild(item);
  });
}

function moveGroupInUserOrder(groupId, dir){
  const i = APP.groups.findIndex(g=>g.id===groupId);
  if(i < 0) return;
  const j = i + dir;
  if(j < 0 || j >= APP.groups.length) return;

  const tmp = APP.groups[i];
  APP.groups[i] = APP.groups[j];
  APP.groups[j] = tmp;

  saveAppData(APP);
  renderGroupListBody();
  renderGroups(); // keep grid synced
}

function applyGroupListChanges(){
  closeModal();
  renderGroups();
}

/* =======================
   GROUP CRUD (upload OR URL)
======================= */
function addMuscleGroup(){
  openModal(`
    <h3>Add Muscle Group</h3>
    <div class="row"><input id="mgName" placeholder="Group name (ex: Calves)"></div>
    <div class="row"><input id="mgImg" placeholder="Image URL (optional)"></div>
    <div class="row"><input id="mgFile" type="file" accept="image/*"></div>
    <div class="hint">Pick <b>either</b> an Image URL <b>or</b> upload an image. Upload overrides URL.</div>
    <div class="actions">
      <button onclick="closeModal()">Cancel</button>
      <button onclick="confirmAddGroup()">Add</button>
    </div>
  `);
}

async function confirmAddGroup(){
  const name = val('mgName');
  let img = val('mgImg');
  const f = fileEl('mgFile')?.files?.[0];

  if(!name){ alert('Enter a group name.'); return; }

  if(f){
    try{ img = await readFileAsDataURL(f); }
    catch{ alert('Could not read image. Try a different file.'); return; }
  }

  APP.groups.push({ id: uid(), name, img, exercises: [] });
  saveAppData(APP);
  closeModal();
  renderGroups();
}

function editMuscleGroup(groupId){
  const g = APP.groups.find(x=>x.id===groupId);
  if(!g) return;

  openModal(`
    <h3>Edit Muscle Group</h3>
    <div class="row"><input id="mgName" placeholder="Group name" value="${escapeHtml(g.name)}"></div>
    <div class="row"><input id="mgImg" placeholder="Image URL (optional)" value="${escapeHtml(g.img||'')}"></div>
    <div class="row"><input id="mgFile" type="file" accept="image/*"></div>
    <div class="hint">To replace the image: paste a URL, or upload a new one. Upload overrides URL.</div>
    <div class="actions">
      <button onclick="closeModal()">Cancel</button>
      <button onclick="confirmEditGroup('${groupId}')">Save</button>
    </div>
  `);
}

async function confirmEditGroup(groupId){
  const g = APP.groups.find(x=>x.id===groupId);
  if(!g) return;

  const newName = val('mgName');
  let newImg  = val('mgImg');
  const f = fileEl('mgFile')?.files?.[0];

  if(!newName){ alert('Enter a group name.'); return; }

  if(f){
    try{ newImg = await readFileAsDataURL(f); }
    catch{ alert('Could not read image. Try a different file.'); return; }
  }

  const oldName = g.name;
  g.name = newName;
  g.img  = newImg;

  migrateWorkoutKeys_GroupRename(oldName, newName);

  saveAppData(APP);
  closeModal();
  renderGroups();
  if(CURRENT_GROUP_ID === groupId) openGroupPanel(groupId);
}

function deleteMuscleGroup(groupId){
  const g = APP.groups.find(x=>x.id===groupId);
  if(!g) return;

  openModal(`
    <h3>Delete Muscle Group</h3>
    <div style="font-weight:900; color:#ffb3bb; margin:6px 0 10px;">
      Delete "${escapeHtml(g.name)}" and ALL its exercises?
    </div>
    <div class="actions">
      <button onclick="closeModal()">Cancel</button>
      <button class="danger" onclick="confirmDeleteGroup('${groupId}')">Delete</button>
    </div>
  `);
}

function confirmDeleteGroup(groupId){
  const g = APP.groups.find(x=>x.id===groupId);
  if(!g) return;

  g.exercises.forEach(ex=>{
    CHART_ORDER.forEach(label=>{
      const k = `${KEY_PREFIX}${safeKey(g.name)}::${safeKey(ex.name)}::${safeKey(label)}`;
      localStorage.removeItem(k);
    });
  });

  APP.groups = APP.groups.filter(x=>x.id!==groupId);
  saveAppData(APP);
  closeModal();
  renderGroups();
  if(CURRENT_GROUP_ID === groupId) closePanel();
}

/* =======================
   EXERCISE CRUD (upload OR URL)
======================= */
function addExercise(groupId){
  const g = APP.groups.find(x=>x.id===groupId);
  if(!g) return;

  openModal(`
    <h3>Add Exercise</h3>
    <div class="row"><input id="exName" placeholder="Exercise name (ex: Calf Raise)"></div>
    <div class="row"><input id="exImg" placeholder="Image URL (optional)"></div>
    <div class="row"><input id="exFile" type="file" accept="image/*"></div>
    <div class="hint">Pick <b>either</b> an Image URL <b>or</b> upload an image. Upload overrides URL.</div>
    <div class="actions">
      <button onclick="closeModal()">Cancel</button>
      <button onclick="confirmAddExercise('${groupId}')">Add</button>
    </div>
  `);
}

async function confirmAddExercise(groupId){
  const g = APP.groups.find(x=>x.id===groupId);
  if(!g) return;

  const name = val('exName');
  let img  = val('exImg');
  const f = fileEl('exFile')?.files?.[0];

  if(!name){ alert('Enter an exercise name.'); return; }

  if(f){
    try{ img = await readFileAsDataURL(f); }
    catch{ alert('Could not read image. Try a different file.'); return; }
  }

  g.exercises.push({ id: uid(), name, img });
  saveAppData(APP);
  closeModal();
  openGroupPanel(groupId);
}

function editExercise(groupId, exId){
  const g = APP.groups.find(x=>x.id===groupId);
  const ex = g?.exercises.find(e=>e.id===exId);
  if(!g || !ex) return;

  openModal(`
    <h3>Edit Exercise</h3>
    <div class="row"><input id="exName" placeholder="Exercise name" value="${escapeHtml(ex.name)}"></div>
    <div class="row"><input id="exImg" placeholder="Image URL (optional)" value="${escapeHtml(ex.img||'')}"></div>
    <div class="row"><input id="exFile" type="file" accept="image/*"></div>
    <div class="hint">To replace the image: paste a URL, or upload a new one. Upload overrides URL.</div>
    <div class="actions">
      <button onclick="closeModal()">Cancel</button>
      <button onclick="confirmEditExercise('${groupId}','${exId}')">Save</button>
    </div>
  `);
}

async function confirmEditExercise(groupId, exId){
  const g = APP.groups.find(x=>x.id===groupId);
  const ex = g?.exercises.find(e=>e.id===exId);
  if(!g || !ex) return;

  const newName = val('exName');
  let newImg  = val('exImg');
  const f = fileEl('exFile')?.files?.[0];

  if(!newName){ alert('Enter an exercise name.'); return; }

  if(f){
    try{ newImg = await readFileAsDataURL(f); }
    catch{ alert('Could not read image. Try a different file.'); return; }
  }

  const oldName = ex.name;
  ex.name = newName;
  ex.img  = newImg;

  migrateWorkoutKeys_ExerciseRename(g.name, oldName, newName);

  saveAppData(APP);
  closeModal();
  openGroupPanel(groupId);
}

function deleteExercise(groupId, exId){
  const g = APP.groups.find(x=>x.id===groupId);
  const ex = g?.exercises.find(e=>e.id===exId);
  if(!g || !ex) return;

  openModal(`
    <h3>Delete Exercise</h3>
    <div style="font-weight:900; color:#ffb3bb; margin:6px 0 10px;">
      Delete "${escapeHtml(ex.name)}" (Warm Up, 1, 2, 3 data included)?
    </div>
    <div class="actions">
      <button onclick="closeModal()">Cancel</button>
      <button class="danger" onclick="confirmDeleteExercise('${groupId}','${exId}')">Delete</button>
    </div>
  `);
}

function confirmDeleteExercise(groupId, exId){
  const g = APP.groups.find(x=>x.id===groupId);
  const ex = g?.exercises.find(e=>e.id===exId);
  if(!g || !ex) return;

  CHART_ORDER.forEach(label=>{
    const k = `${KEY_PREFIX}${safeKey(g.name)}::${safeKey(ex.name)}::${safeKey(label)}`;
    localStorage.removeItem(k);
  });

  g.exercises = g.exercises.filter(e=>e.id!==exId);
  saveAppData(APP);
  closeModal();
  openGroupPanel(groupId);
}

/* =======================
   KEY MIGRATIONS
======================= */
function migrateWorkoutKeys_GroupRename(oldGroup, newGroup){
  const oldPrefix = `${KEY_PREFIX}${safeKey(oldGroup)}::`;
  const keys = Object.keys(localStorage).filter(k => k.startsWith(oldPrefix));
  keys.forEach(oldKey=>{
    const v = localStorage.getItem(oldKey);
    const rest = oldKey.slice(oldPrefix.length);
    const newKey = `${KEY_PREFIX}${safeKey(newGroup)}::${rest}`;
    localStorage.setItem(newKey, v);
    localStorage.removeItem(oldKey);
  });
}

function migrateWorkoutKeys_ExerciseRename(groupName, oldEx, newEx){
  const base = `${KEY_PREFIX}${safeKey(groupName)}::`;
  CHART_ORDER.forEach(label=>{
    const oldKey = `${base}${safeKey(oldEx)}::${safeKey(label)}`;
    const v = localStorage.getItem(oldKey);
    if(v !== null){
      const newKey = `${base}${safeKey(newEx)}::${safeKey(label)}`;
      localStorage.setItem(newKey, v);
      localStorage.removeItem(oldKey);
    }
  });
}

/* =======================
   EXPORT / IMPORT (supports v4 + older v2)
======================= */
function exportData(){
  const out = {
    meta:{ app:'Babe Sculpting', version:4, exportedAt:new Date().toISOString() },
    appData: APP,
    gridCols: getGridCols(),
    workouts: {}
  };

  Object.keys(localStorage).forEach(k=>{
    if(!k.startsWith(KEY_PREFIX)) return;
    if(k === APP_KEY) return;
    if(k === GRID_KEY) return;

    const raw = localStorage.getItem(k);
    try{
      out.workouts[k] = JSON.parse(raw);
    }catch{
      out.workouts[k] = raw;
    }
  });

  const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'babe_sculpting_data.json';
  a.click();
}

document.getElementById('importFile').onchange = e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const d = JSON.parse(r.result);

      Object.keys(localStorage).forEach(k=>{
        if(!k.startsWith(KEY_PREFIX)) return;
        if(k === APP_KEY) return;
        if(k === GRID_KEY) return;
        localStorage.removeItem(k);
      });

      if(d && d.appData && Array.isArray(d.appData.groups)){
        APP = d.appData;
        saveAppData(APP);

        if(typeof d.gridCols === 'number') applyGridCols(d.gridCols);

        if(d.workouts && typeof d.workouts === 'object'){
          Object.keys(d.workouts).forEach(k=>{
            if(!k.startsWith(KEY_PREFIX)) return;
            if(k === APP_KEY) return;
            if(k === GRID_KEY) return;
            const v = d.workouts[k];
            localStorage.setItem(k, typeof v === 'string' ? v : JSON.stringify(v ?? {}));
          });
        }

        alert('Import complete.');
        renderGroups();
        closePanel();
        return;
      }

      if(d && Array.isArray(d.groups) && d.groups.length){
        const defaults = defaultAppData().groups;
        const defByName = (name)=>defaults.find(g=>g.name === name);

        const newGroups = d.groups.map(g=>{
          const defG = defByName(g.group);
          const groupImg = defG?.img || '';

          const exercises = (g.exercises || []).map(ex=>{
            const defEx = defG?.exercises?.find(x=>x.name === ex.name);
            return { id: uid(), name: ex.name, img: defEx?.img || '' };
          });

          return { id: uid(), name: g.group, img: groupImg, exercises };
        });

        APP = { version: 1, groups: newGroups };
        saveAppData(APP);

        d.groups.forEach(g=>{
          (g.exercises || []).forEach(ex=>{
            (ex.charts || []).forEach(c=>{
              if(!c || !c.label) return;
              const k = `${KEY_PREFIX}${safeKey(g.group)}::${safeKey(ex.name)}::${safeKey(c.label)}`;
              localStorage.setItem(k, JSON.stringify({
                weight: Number(c.weight) || 0,
                set: Number(c.set) || 0
              }));
            });
          });
        });

        if(typeof d.gridCols === 'number') applyGridCols(d.gridCols);

        alert('Import complete.');
        renderGroups();
        closePanel();
        return;
      }

      alert('Import failed. Unrecognized file format.');
    }catch(err){
      alert('Import failed. Invalid file.');
    }
  };
  r.readAsText(f);
};

/* =======================
   RESET (only this app)
======================= */
function resetBabeSculpting(){
  if(!confirm('This will ERASE ALL Babe Sculpting data (groups, exercises, workout entries). Continue?')) return;

  Object.keys(localStorage)
    .filter(k => k.startsWith(KEY_PREFIX))
    .forEach(k => localStorage.removeItem(k));

  localStorage.removeItem(APP_KEY);

  APP = loadAppData();
  renderGroups();
  closePanel();
}

/* =======================
   INIT
======================= */
applyGridCols(getGridCols());
renderGroups();
</script>

</body>
</html>